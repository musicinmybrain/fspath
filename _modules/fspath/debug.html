
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>fspath.debug &#8212; FSPath 20190323 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">FSPath 20190323 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">fspath.debug</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for fspath.debug</h1><div class="highlight"><pre>
<span></span>#!/usr/bin/env python
# -*- coding: utf-8; mode: python -*-
# pylint: disable=invalid-name, logging-not-lazy

&quot;&quot;&quot;
Small collection for debugging and introspection purpose.
&quot;&quot;&quot;

# ==============================================================================
#  imports ...
# ==============================================================================

import sys
import socket
import pdb
import inspect
import linecache
import time
import logging

from code   import InteractiveConsole
from codeop import CommandCompiler
from telnetlib import Telnet
import six

__all__ = [&#39;Console&#39;, &#39;RemoteConsole&#39;, &#39;RemotePdb&#39;, &#39;rtrace&#39;, &#39;trace&#39;]

logger = logging.getLogger(&#39;fspath.debug&#39;)
ERROR  = logger.error

# ==============================================================================
def descrFrame(frame, arround=3):
# ==============================================================================
    u&quot;&quot;&quot;get description of the code frame&quot;&quot;&quot;
    fName  = frame.f_code.co_filename
    lineNo = frame.f_lineno
    lines = []
    for c in range(lineNo - arround, lineNo + arround):
        if c &gt; 0:
            prefix = &quot;%-04s|&quot; % c
            if c == lineNo:
                prefix = &quot;----&gt;&quot;
            line = linecache.getline(fName, c, frame.f_globals)
            if line != &#39;&#39;:
                lines.append(prefix + line)
            else:
                if lines:
                    lines[-1] = lines[-1] + &quot;&lt;EOF&gt;\n&quot;
                break
    retVal = (
        &quot;&quot;.join(lines)
        + &quot;file: %s:%s\n&quot; % (fName, lineNo)
        )
    return retVal

# ==============================================================================
<div class="viewcode-block" id="Console"><a class="viewcode-back" href="../../fspath-api/fspath.debug.html#fspath.debug.Console">[docs]</a>class Console(InteractiveConsole):
# ==============================================================================

    u&quot;&quot;&quot;A simple interactive console.
    &quot;&quot;&quot;

    EOF = None

    # pylint: disable=super-init-not-called
    def __init__(self, local_ns=None, global_ns=None, filename=&quot;&lt;console&gt;&quot;):
        if local_ns is None:
            local_ns = {&quot;__name__&quot;: &quot;__console__&quot;, &quot;__doc__&quot;: None}

        if global_ns is None:
            global_ns = {}

        self.local_ns  = local_ns
        self.global_ns = global_ns
        self.compile   = CommandCompiler()
        self.filename = filename
        self.resetbuffer()

<div class="viewcode-block" id="Console.raw_input"><a class="viewcode-back" href="../../fspath-api/fspath.debug.html#fspath.debug.Console.raw_input">[docs]</a>    def raw_input(self, prompt=&quot;&quot;):
        if self.EOF is None:
            return six.moves.input(prompt)
        sys.stdout.write(prompt)
        sys.stdout.flush()
        line = sys.stdin.readline()
        ERROR(repr(line))
        if line.strip() == self.EOF:
            raise EOFError
        return line</div>

<div class="viewcode-block" id="Console.write"><a class="viewcode-back" href="../../fspath-api/fspath.debug.html#fspath.debug.Console.write">[docs]</a>    def write(self, data):
        sys.stdout.write(data)
        sys.stdout.flush()</div>

<div class="viewcode-block" id="Console.runcode"><a class="viewcode-back" href="../../fspath-api/fspath.debug.html#fspath.debug.Console.runcode">[docs]</a>    def runcode(self, code):
        try:
            exec(code, self.global_ns, self.local_ns) # pylint: disable=W0122
        except SystemExit:   # pylint: disable=try-except-raise
            raise
        except Exception:    # pylint: disable=W0703
            self.showtraceback()</div>

<div class="viewcode-block" id="Console.run"><a class="viewcode-back" href="../../fspath-api/fspath.debug.html#fspath.debug.Console.run">[docs]</a>    @classmethod
    def run(cls, local_ns=None, global_ns=None
            , banner=None, filename=&quot;&lt;console&gt;&quot;
            , frame=None, EOF=None): # pylint: disable=C0103
        u&quot;&quot;&quot;Start console

        Without setting explicit namespaces (``local_ns``, ``global_ns``),
        the namespaces from the current code-frame are uused.

        .. code-block:: python

          def foo(arg1):
              ...
              Console.run()

        &quot;&quot;&quot;
        frame = frame or inspect.currentframe().f_back
        if banner is None:
            banner = &quot;console ...\n%s&quot; % descrFrame(frame)
        if local_ns is None:
            local_ns = frame.f_locals
        if global_ns is None:
            global_ns = frame.f_globals
        #inspect.currentframe().f_back
        console = cls(local_ns, global_ns, filename)
        if EOF:
            banner += &quot;\nExit console with %r&quot; % EOF
            console.EOF = EOF # pylint: disable=C0103
        console.interact(banner=banner)</div></div>

# ==============================================================================
<div class="viewcode-block" id="RemoteConsole"><a class="viewcode-back" href="../../fspath-api/fspath.debug.html#fspath.debug.RemoteConsole">[docs]</a>class RemoteConsole(Console):
# ==============================================================================

    u&quot;&quot;&quot;A simple remote console.

    Works just like the ``Console`` except the console can be reached from a
    remote (terminal session).
    &quot;&quot;&quot;

    EOF = &#39;EOF&#39;

<div class="viewcode-block" id="RemoteConsole.interact"><a class="viewcode-back" href="../../fspath-api/fspath.debug.html#fspath.debug.RemoteConsole.interact">[docs]</a>    def interact(self, port, addr=&quot;127.0.0.1&quot;, banner=None): # pylint: disable=arguments-differ

        old_stdout = sys.stdout
        old_stderr = sys.stderr
        old_stdin  = sys.stdin

        skt = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        skt.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, True)
        skt.bind((addr, port))
        skt.listen(1)
        ERROR(&quot;accept connection %s:%s&quot; % (addr, port))
        (conn, remote) = skt.accept()
        ERROR(&quot;got connection from %s:%s&quot; % remote)
        rwStream = conn.makefile(&#39;rw&#39;, 0)
        ERROR(&quot;redirect&quot;)
        sys.stderr = sys.stdout = sys.stdin = rwStream

        try:
            Console.interact(self, banner)
        except Exception as exc:  # pylint: disable=W0703
            ERROR(str(exc))

        try:
            rwStream.close()
        except Exception as exc:  # pylint: disable=W0703
            ERROR(&quot;error on closing stream: &quot; + str(exc))

        try:
            skt.close()
        except Exception as exc:  # pylint: disable=W0703
            ERROR(&quot;error on closing socket: &quot; + str(exc))

        #ERROR(&quot;re-redirect&quot;)
        sys.stdout = old_stdout
        sys.stderr = old_stderr
        sys.stdin  = old_stdin
        ERROR(&quot;close connection ...&quot;)
        ERROR(&quot;connection %s:%s closed&quot; % remote)</div>

<div class="viewcode-block" id="RemoteConsole.run"><a class="viewcode-back" href="../../fspath-api/fspath.debug.html#fspath.debug.RemoteConsole.run">[docs]</a>    @classmethod
    def run(cls, port, local_ns=None, global_ns=None  # pylint: disable=arguments-differ
            , banner=None, filename=&quot;&lt;console&gt;&quot;
            , frame=None, EOF=None):
        u&quot;&quot;&quot;Starts a remote console

        The first argument is needed, it is the port number for the remote
        connection.

        .. code-block:: python

          def foo(arg1):
              ...
              RemoteConsole.run(4444) # terminal on port 4444

        The string &#39;EOF&#39; ends the remote session.

        &quot;&quot;&quot;
        frame = frame or inspect.currentframe().f_back
        if banner is None:
            banner = &quot;console ...\n%s&quot; % descrFrame(frame)
        if EOF:
            banner += &quot;\nExit console with %r&quot; % EOF
        if local_ns is None:
            local_ns = frame.f_locals
        if global_ns is None:
            global_ns = frame.f_globals
        #inspect.currentframe().f_back
        console = cls(local_ns, global_ns, filename)
        if EOF:
            banner += &quot;\nExit console with %r&quot; % EOF
            console.EOF = EOF
        console.interact(port, banner=banner)</div></div>


# ==============================================================================
class Pdb(pdb.Pdb):  # pylint: disable=R0904
# ==============================================================================

    # pylint: disable=no-self-use, missing-docstring
    u&quot;&quot;&quot;Abstraction Layer for PDB&quot;&quot;&quot;
    def do_src(self, arg):
        if not arg:
            arg = 3
        six.print_(descrFrame(self.curframe, int(arg)))

    def help_src(self):
        six.print_(&quot;&quot;&quot;show
Show source around current command (frame)
&quot;&quot;&quot;)

    def do_console(self, arg):  # pylint: disable=W0613
        Console.run(frame=self.curframe, EOF=&#39;EOF&#39;)

    def help_console(self):
        six.print_(&quot;&quot;&quot;console
run an interactive console in the current frame.
&quot;&quot;&quot;)


# ==============================================================================
<div class="viewcode-block" id="RemotePdb"><a class="viewcode-back" href="../../fspath-api/fspath.debug.html#fspath.debug.RemotePdb">[docs]</a>class RemotePdb(Pdb): # pylint: disable=R0904
# ==============================================================================
    u&quot;&quot;&quot;Simple remote PDB&quot;&quot;&quot;

    # pylint: disable=no-self-use, missing-docstring
    # pylint: disable=super-init-not-called
    def __init__(self, port, addr=&quot;127.0.0.1&quot;):
        &quot;&quot;&quot;Initialize the socket and initialize pdb.&quot;&quot;&quot;

        self.old_stdout = sys.stdout
        self.old_stderr = sys.stderr
        self.old_stdin  = sys.stdin

        self.skt = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        self.skt.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, True)
        self.skt.bind((addr, port))
        self.skt.listen(1)
        ERROR(&quot;accept connection %s:%s&quot; % (addr, port))
        (conn, self.remote) = self.skt.accept()
        ERROR(&quot;got connection from %s:%s&quot; % self.remote)
        self.rwStream = conn.makefile(&#39;rw&#39;, 0)
        sys.stderr = sys.stdout = sys.stdin = self.rwStream
        Pdb.__init__(self, completekey=&#39;tab&#39;)
        ERROR(&quot;pdb inited&quot;)

<div class="viewcode-block" id="RemotePdb.shutdown"><a class="viewcode-back" href="../../fspath-api/fspath.debug.html#fspath.debug.RemotePdb.shutdown">[docs]</a>    def shutdown(self):
        u&quot;&quot;&quot;shutdown PDB&#39;s&#39; REPL&quot;&quot;&quot;
        try:
            self.rwStream.close()
        except Exception as exc: # pylint: disable=W0703
            ERROR(&quot;error on closing stream: &quot; + str(exc))

        try:
            self.skt.close()
        except Exception as exc: # pylint: disable=W0703
            ERROR(&quot;error on closing socket: &quot; + str(exc))

        ERROR(&quot;re-redirect&quot;)
        sys.stdout = self.old_stdout
        sys.stderr = self.old_stderr
        sys.stdin  = self.old_stdin
        ERROR(&quot;close connection ...&quot;)
        self.set_continue()
        ERROR(&quot;connection %s:%s closed&quot; % self.remote)</div>

<div class="viewcode-block" id="RemotePdb.do_continue"><a class="viewcode-back" href="../../fspath-api/fspath.debug.html#fspath.debug.RemotePdb.do_continue">[docs]</a>    def do_continue(self, arg):
        &quot;&quot;&quot;Stop all operation on ``continue``.&quot;&quot;&quot;
        self.shutdown()
        return 1</div>

    do_EOF = do_quit = do_exit = do_c = do_cont = do_continue</div>


# ==============================================================================
<div class="viewcode-block" id="trace"><a class="viewcode-back" href="../../fspath-api/fspath.debug.html#fspath.debug.trace">[docs]</a>def trace(frame=None):
# ==============================================================================

    u&quot;&quot;&quot;A breakpoint starting a ``Pdb`` session.
    &quot;&quot;&quot;
    frame = frame or inspect.currentframe().f_back
    Pdb().set_trace(frame=frame)</div>

# ==============================================================================
<div class="viewcode-block" id="rtrace"><a class="viewcode-back" href="../../fspath-api/fspath.debug.html#fspath.debug.rtrace">[docs]</a>def rtrace(port=4444, addr=&quot;127.0.0.1&quot;, frame=None):
# ==============================================================================

    u&quot;&quot;&quot;A breakpoint, starting a ``RemotePdb`` session. Default port ist 4444
    &quot;&quot;&quot;
    frame = frame or inspect.currentframe().f_back
    RemotePdb(port, addr).set_trace(frame=frame)</div>


# ==============================================================================
class DumpTelnet(Telnet):
# ==============================================================================

    u&quot;&quot;&quot;Inheritance fixing ``telnetlib.Telnet`` where it fails.
    &quot;&quot;&quot;
    def listener(self):
        &quot;&quot;&quot;Helper for mt_interact() -- this executes in the other thread.&quot;&quot;&quot;
        while 1:
            try:
                data = self.read_eager()
            except EOFError:
                six.print_(&#39;*** Connection closed by remote host ***&#39;)
                return
            if data:
                if six.PY3:
                    sys.stdout.write(data.decode(&#39;ascii&#39;))
                else:
                    sys.stdout.write(data)
            else:
                sys.stdout.flush()
            # without sleep cpu usage is 100%
            time.sleep(0.01)

# ==============================================================================
def rtrace_client(port=4444, addr=&quot;127.0.0.1&quot;, polltime=None):
# ==============================================================================
    u&quot;&quot;&quot;Set breakpoint for remote debugging&quot;&quot;&quot;
    while True:
        try:
            t = DumpTelnet(addr, port)
            t.interact()
            t.close()
        except Exception: # pylint: disable=broad-except
            pass
        if polltime is None:
            break
        time.sleep(polltime)


# def _test():
#     x = 12
#     rtrace()
#     x = 47
#     #RemoteConsole.run(4444)
#     #Console.run()
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
  <span id="sidebar-top"></span>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  
    
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/darmarIT_logo_128.png" alt="Logo"/>
            </a></p>
  
<h3>Navigation</h3>
<ul>
  <li><a href="../../index.html">Overview</a>
    <ul>
      <li><a href="../index.html">Module code</a>
        
          
          </ul>
      </li>
    </ul>
  </li>
</ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script><div id="ethical-ad-placement"></div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
  
    <div class="footer" role="contentinfo">
        &#169; Copyright 2023 Markus Heiser.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 6.1.3.
    </div>
  <script src="../../_static/version_warning_offset.js"></script>

  </body>
</html>